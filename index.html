<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reading Practice ‚Äî QA Version</title>
<style>
  :root{
    --bg:#f7f9fc;
    --card:#ffffff;
    --line:#e5e7eb;
    --text:#0f172a;
    --muted:#6b7280;
    --ok:#16a34a;
    --bad:#ef4444;
    --accent:#1f2937;
    --topic:#dc2626; /* ƒë·ªè cho Topic */
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    font:13px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:#ffffff; color:var(--text);
  }

  /* khung t·ªïng */
  .wrap{
    max-width:1920px;
    margin:auto;
    padding:10px;
    height:100%;
    display:flex; flex-direction:column; gap:16px;
  }

  /* header */
  header h1{margin:0 0 2px;font-size:22px;font-weight:800;letter-spacing:.2px}
  header p{margin:0 0 10px;color:var(--muted)}

  /* thanh c√¥ng c·ª• (gi·ªØ nguy√™n n√∫t) */
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  label{display:inline-flex;gap:8px;align-items:center}
  select,button,input[type="checkbox"]{vertical-align:middle}
  select,button{
    padding:8px 12px;border-radius:10px;border:1px solid var(--line);
    background:#fff;color:var(--text)
  }
  button{cursor:pointer;font-weight:600;box-shadow:0 1px 0 rgba(0,0,0,.03)}
  button:hover{background:#f8fafc}
  .chk{
    display:inline-flex;gap:8px;align-items:center;
    padding:6px 10px;border-radius:10px;border:1px solid var(--line);background:#fff
  }
  .nav{display:flex;gap:8px;margin-left:auto}

  /* Topic n·ªïi b·∫≠t nh∆∞ ·∫£nh m·∫´u */
  #desc{
    display:block; /* bi·∫øn pill th√†nh d√≤ng ti√™u ƒë·ªÅ */
    margin:8px 0 0;
    font-size:20px;font-weight:800;color:var(--topic);
    background:transparent;border:0;padding:0
  }

  /* l∆∞·ªõi 2 c·ªôt */
  .grid{display:grid;gap:16px;grid-template-columns:1.2fr 1fr;flex:1;min-height:0}

  /* card */
  .card{
    background:var(--card); border:1px solid var(--line); border-radius:14px;
    box-shadow:0 6px 18px rgba(17,24,39,.06);
    display:flex;flex-direction:column;overflow:auto
  }
  .passages,.questions{padding:18px}
  .passages h3,.questions h3{margin:0 0 12px;font-size:18px;font-weight:800}

  /* ƒëo·∫°n vƒÉn */
  .p-item+.p-item{margin-top:12px}
  .p-title{font-weight:500}

  /* danh s√°ch c√¢u h·ªèi */
  .q-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:12px}
  .q{
    display:grid;grid-template-columns:1fr 240px;align-items:center;
    gap:12px;
    border:1px solid var(--line); border-radius:10px; padding:10px 12px;
    background:#fff;
  }
  .q.ok{border-color:var(--ok); box-shadow:0 0 0 3px rgba(22,163,74,.12) inset}
  .q.bad{border-color:var(--bad); box-shadow:0 0 0 3px rgba(239,68,68,.12) inset}

  .q label{font-weight:500}
  select.answer{
    width:100%; padding:8px 10px; background:#fff;
    border:1px solid var(--line); border-radius:10px;
  }
  select.answer:focus{outline:2px solid #c7d2fe; outline-offset:2px}

  /* khu ƒëi·ªÅu khi·ªÉn b√™n d∆∞·ªõi */
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
  .score{font-weight:800;margin-left:auto}

  /* responsive */
  @media (max-width: 960px){
    .grid{grid-template-columns:1fr}
    .q{grid-template-columns:1fr}
    .nav{width:100%;justify-content:flex-start;margin-left:0}
    #desc{font-size:18px}
  }
</style>

</head>
<body>
<div class="wrap">
  <header>
    <h1>Reading Practice</h1>
    <div class="toolbar">
      <label>Topic:
        <select id="topicSelect"></select>
      </label>
      <label>Version:
        <select id="versionSelect"></select>
      </label>
      <label class="chk">
        <input type="checkbox" id="autoShuffle" checked />
        Auto-shuffle on load
      </label>
      <span id="desc" class="pill"></span>
      <div class="nav">
        <button id="prevTopic">‚üµ Prev Topic</button>
        <button id="nextTopic">Next Topic ‚ü∂</button>
        <button id="prevVer" title="Previous version">v‚üµ</button>
        <button id="nextVer" title="Next version">‚ü∂v</button>
      </div>
    </div>
  </header>

  <section class="grid">
    <article class="card passages">
      <h3>Paragraphs</h3>
      <div id="paragraphs"></div>
    </article>

    <aside class="card questions">
      <ul class="q-list" id="qList"></ul>
      <div class="controls">
        <button id="checkBtn">Check</button>
        <button id="showKeyBtn">Show Key</button>
        <button id="shuffleBtn">Shuffle</button>
        <button id="resetBtn">Reset</button>
        <span class="score" id="score"></span>
      </div>
    </aside>
  </section>
</div>

<script type="module">
  const DATA_DIR = 'data';
  const MANIFEST_URL = `${DATA_DIR}/manifest.json`;
let manifest=null, topicIdx=0, verIdx=0, currentQA=[];
const els={
  topic:document.getElementById('topicSelect'),
  version:document.getElementById('versionSelect'),
  autoShuffle:document.getElementById('autoShuffle'),
  desc:document.getElementById('desc'),
  paras:document.getElementById('paragraphs'),
  qList:document.getElementById('qList'),
  score:document.getElementById('score')
};

/* ---------- Utils ---------- */
const shuffle = a => a.map(x=>({r:Math.random(),x})).sort((p,q)=>p.r-q.r).map(o=>o.x);

/* ---------- Manifest ---------- */
async function loadManifest(){
  const res=await fetch('data/manifest.json',{cache:'no-store'});
  manifest=await res.json();
  els.topic.innerHTML='';
  manifest.topics.forEach((t,i)=>{
    const o=document.createElement('option');
    o.value=i;
    o.textContent=t.title;
    els.topic.appendChild(o);
  });
  loadTopic(0,0);
}

function fillVersions(){
  const t=manifest.topics[topicIdx];
  els.version.innerHTML='';
  t.versions.forEach((v,i)=>{
    const o=document.createElement('option');
    o.value=i;
    o.textContent=v.ver.toUpperCase();
    els.version.appendChild(o);
  });
  els.version.value=verIdx;
  els.desc.textContent=`${t.title} ‚Äî ${t.versions[verIdx].ver.toUpperCase()}`;
}

/* ---------- Render ---------- */
async function loadTopic(ti,vi){
  topicIdx=ti; verIdx=vi;
  els.paras.innerHTML=''; els.qList.innerHTML=''; els.score.textContent='';
  fillVersions();

  const file = manifest.topics[topicIdx].versions[verIdx].path;
  const mod = await import(`./data/${file}?v=${Date.now()}`);

  // render paragraphs
  (mod.data || []).forEach(p=>{
    const div=document.createElement('div');
    div.className='p-item';
    div.innerHTML=`<div class="p-title">${p}</div>`;
    els.paras.appendChild(div);
  });

  // render QA
  currentQA = Array.isArray(mod.qa) ? [...mod.qa] : [];
  if (els.autoShuffle.checked) currentQA = shuffle(currentQA);
  renderQA(currentQA);
}

function renderQA(qa){
  els.qList.innerHTML='';
  qa.forEach(({question,key})=>{
    const li=document.createElement('li');
    li.className='q';
    li.dataset.k=key;
    const sel=document.createElement('select');
    sel.className='answer';
    sel.innerHTML='<option value="" disabled selected>Select answer</option>'+
      ['A','B','C','D'].map(a=>`<option value="${a}">${a}</option>`).join('');
    li.appendChild(Object.assign(document.createElement('label'),{textContent:question}));
    li.appendChild(sel);
    els.qList.appendChild(li);
  });
}

/* ---------- Actions ---------- */
function check(){
  let correct=0;
  const all = document.querySelectorAll('.q');
  all.forEach(li=>{
    const sel=li.querySelector('select');
    li.classList.remove('ok','bad');
    if(!sel.value){li.classList.add('bad');return;}
    if(sel.value===li.dataset.k){li.classList.add('ok');correct++;}
    else li.classList.add('bad');
  });

  els.score.textContent=`Score: ${correct}/${all.length}`;

  // ‚úÖ N·∫øu ƒë√∫ng h·∫øt ‚Üí chuy·ªÉn version / topic k·∫ø
  if (correct === all.length){
    const t = manifest.topics[topicIdx];
    const nextVer = verIdx + 1;
    if (nextVer < t.versions.length){
      // C√≤n version ti·∫øp theo trong topic
      verIdx = nextVer;
      alert(`üéâ Ch√≠nh x√°c h·∫øt! Chuy·ªÉn sang ${t.title} ${t.versions[verIdx].ver.toUpperCase()}`);
      loadTopic(topicIdx, verIdx);
    } else {
      // H·∫øt version ‚Üí sang topic k·∫ø
      topicIdx = (topicIdx + 1) % manifest.topics.length;
      verIdx = 0;
      alert(`‚úÖ Ho√†n t·∫•t ${t.title}! Sang topic ti·∫øp theo: ${manifest.topics[topicIdx].title}`);
      els.topic.value = topicIdx;
      loadTopic(topicIdx, verIdx);
    }
  }
}

function showKey(){
  document.querySelectorAll('.q').forEach(li=>{
    const sel=li.querySelector('select');
    [...sel.options].forEach(o=>{
      if(o.value===li.dataset.k && !o.textContent.includes('‚úì'))
        o.textContent += ' ‚úì';
    });
  });
}

function reset(){
  els.score.textContent='';
  document.querySelectorAll('.q').forEach(li=>li.classList.remove('ok','bad'));
  document.querySelectorAll('select.answer').forEach(s=>s.value='');
}

function shuffleNow(){
  if(!currentQA.length) return;
  currentQA = shuffle(currentQA);
  renderQA(currentQA);
  els.score.textContent='';
}

/* ---------- Navigation ---------- */
function nextTopic(){
  topicIdx=(topicIdx+1)%manifest.topics.length;
  verIdx=0;
  els.topic.value=topicIdx;
  loadTopic(topicIdx,verIdx);
}
function prevTopic(){
  topicIdx=(topicIdx-1+manifest.topics.length)%manifest.topics.length;
  verIdx=0;
  els.topic.value=topicIdx;
  loadTopic(topicIdx,verIdx);
}
function nextVer(){
  const t=manifest.topics[topicIdx];
  verIdx=(verIdx+1)%t.versions.length;
  loadTopic(topicIdx,verIdx);
}
function prevVer(){
  const t=manifest.topics[topicIdx];
  verIdx=(verIdx-1+t.versions.length)%t.versions.length;
  loadTopic(topicIdx,verIdx);
}

/* ---------- Events ---------- */
els.topic.addEventListener('change',e=>loadTopic(+e.target.value,0));
els.version.addEventListener('change',e=>loadTopic(topicIdx,+e.target.value));
document.getElementById('checkBtn').addEventListener('click',check);
document.getElementById('showKeyBtn').addEventListener('click',showKey);
document.getElementById('resetBtn').addEventListener('click',reset);
document.getElementById('shuffleBtn').addEventListener('click',shuffleNow);
document.getElementById('nextTopic').addEventListener('click',nextTopic);
document.getElementById('prevTopic').addEventListener('click',prevTopic);
document.getElementById('nextVer').addEventListener('click',nextVer);
document.getElementById('prevVer').addEventListener('click',prevVer);

/* ---------- Boot ---------- */
loadManifest();
</script>
</body>
</html>
